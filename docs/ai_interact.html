<!DOCTYPE html>
<html lang="en">
<head>
<script>
  const openaiKey = localStorage.getItem("openaiKey");
  const githubToken = localStorage.getItem("githubToken");
  if (!openaiKey || !githubToken) {
    alert("üîê Missing API keys. Redirecting to setup...");
    window.location.href = "setup.html";
  }
</script>
<script>
  const openaiKey = localStorage.getItem("openaiKey");
  if (!openaiKey) {
    alert("üîê Missing OpenAI API key. Redirecting to setup...");
    window.location.href = "setup.html";
  }
</script>
  <meta charset="UTF-8">
  <title>AI Dev Agent Console</title>
  <script defer src="https://pyscript.net/latest/pyscript.js"></script>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css">
</head>
<body class="bg-gray-900 text-white p-8 font-mono">
  <h1 class="text-4xl font-bold mb-6">üß† Autonomous Dev Agent</h1>
  <div class="mb-4">
    <label for="aiInput" class="block mb-2 text-sm">Enter Command for AI</label>
    <textarea id="aiInput" class="w-full p-2 rounded text-black" rows="5" placeholder="Tell the AI to refactor a module, analyze a bug, or plan a new feature..."></textarea>
    <button id="runAI" class="mt-3 bg-blue-600 hover:bg-blue-700 px-4 py-2 rounded">Run AI Command</button>
  </div>
  <div id="aiOutput" class="bg-gray-800 p-4 mt-4 rounded text-green-400 text-sm whitespace-pre-wrap"></div>

  <py-script>
from js import document
import openai
import asyncio

async def run_ai():
    prompt = document.getElementById("aiInput").value
    if not prompt:
        document.getElementById("aiOutput").innerText = "Please enter a prompt."
        return
    openai.api_key = window.localStorage.getItem("openaiKey")  # Set via environment or injected secret
    try:
        response = await openai.ChatCompletion.acreate(
            model="gpt-4-turbo",
            messages=[{"role": "user", "content": prompt}]
        )
        result = response['choices'][0]['message']['content']
    except Exception as e:
        result = f"‚ö†Ô∏è Error: {e}"
    document.getElementById("aiOutput").innerText = result

Element("runAI").element.onclick = lambda *_: asyncio.ensure_future(run_ai())
  </py-script>

<div id="statusBadge" class="fixed top-4 right-4 z-50 px-3 py-1 rounded bg-green-600 text-white text-xs shadow">
  ‚úÖ Authenticated
</div>
<script>
  const statusBadge = document.getElementById("statusBadge");
  const openaiKey = localStorage.getItem("openaiKey");
  const githubToken = localStorage.getItem("githubToken");

  if (!openaiKey || !githubToken) {
    alert("üîê Missing API keys. Redirecting to setup...");
    window.location.href = "setup.html";
  }
</script>


<style>
  @keyframes pulseGlow {
    0%, 100% { box-shadow: 0 0 0 0 rgba(72, 187, 120, 0.7); }
    50% { box-shadow: 0 0 10px 4px rgba(72, 187, 120, 0.7); }
  }
</style>
<div id="statusBadge" class="fixed top-4 right-4 z-50 px-3 py-1 rounded bg-green-600 text-white text-xs shadow animate-pulse" style="animation: pulseGlow 2s infinite;">
  ‚úÖ Authenticated
</div>
<script>
  const statusBadge = document.getElementById("statusBadge");
  const openaiKey = localStorage.getItem("openaiKey");
  const githubToken = localStorage.getItem("githubToken");

  if (!openaiKey || !githubToken) {
    alert("üîê Missing API keys. Redirecting to setup...");
    window.location.href = "setup.html";
  }
</script>


<style>
  @keyframes pulseGlow {
    0%, 100% { box-shadow: 0 0 0 0 rgba(72, 187, 120, 0.7); }
    50% { box-shadow: 0 0 10px 4px rgba(72, 187, 120, 0.7); }
  }
  .badge-error {
    background-color: #DC2626 !important;
    animation: none !important;
    box-shadow: 0 0 0 2px rgba(220, 38, 38, 0.7);
  }
</style>

<div id="statusBadge" class="fixed top-4 right-4 z-50 px-3 py-1 rounded bg-green-600 text-white text-xs shadow" style="animation: pulseGlow 2s infinite;">
  ‚úÖ Authenticated
</div>

<script>
  const badge = document.getElementById("statusBadge");
  const openaiKey = localStorage.getItem("openaiKey");
  const githubToken = localStorage.getItem("githubToken");

  if (!openaiKey || !githubToken) {
    alert("üîê Missing API keys. Redirecting to setup...");
    window.location.href = "setup.html";
  }

  // Live test ping OpenAI and GitHub once to update badge status
  async function verifyLiveAuth() {
    let success = true;

    try {
      const aiRes = await fetch("https://api.openai.com/v1/models", {
        headers: { Authorization: `Bearer ${openaiKey}` }
      });
      if (!aiRes.ok) success = false;
    } catch (err) { success = false; }

    try {
      const ghRes = await fetch("https://api.github.com/user", {
        headers: { Authorization: `token ${githubToken}` }
      });
      if (!ghRes.ok) success = false;
    } catch (err) { success = false; }

    if (!success) {
      badge.innerText = "‚ùå Auth Error";
      badge.classList.add("badge-error");
    }
  }

  verifyLiveAuth();
</script>

</body>
</html>
