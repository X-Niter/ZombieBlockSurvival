<!DOCTYPE html>
<html lang="en">
<head>
<script>
  const openaiKey = localStorage.getItem("openaiKey");
  const githubToken = localStorage.getItem("githubToken");
  if (!openaiKey || !githubToken) {
    alert("üîê Missing API keys. Redirecting to setup...");
    window.location.href = "setup.html";
  }
</script>
<script>
  const openaiKey = localStorage.getItem("openaiKey");
  if (!openaiKey) {
    alert("üîê Missing OpenAI API key. Redirecting to setup...");
    window.location.href = "setup.html";
  }
</script>
  <meta charset="UTF-8">
  <title>üß† AI Diagnostics Dashboard</title>
  <script defer src="https://pyscript.net/latest/pyscript.js"></script>
  <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
</head>
<body class="bg-gray-900 text-white p-6 font-mono">
  <h1 class="text-4xl mb-6 font-bold">üõ† AI Diagnostics Dashboard</h1>
  <p class="mb-4 text-sm">This dashboard pulls from self-test logs and allows AI to attempt fixes directly.</p>

  <div class="mb-4">
    <label for="logInput" class="block text-sm mb-1">Paste diagnostics log content:</label>
    <textarea id="logInput" rows="10" class="w-full p-2 rounded text-black" placeholder="Paste logs here..."></textarea>
    <button id="analyzeBtn" class="mt-3 bg-blue-600 hover:bg-blue-700 px-4 py-2 rounded">Analyze & Fix</button>
  </div>

  <div id="aiOutput" class="bg-gray-800 p-4 mt-4 rounded text-green-400 whitespace-pre-wrap"></div>

  <py-script output="aiOutput">
import openai
from js import document

def fix_logs(evt):
    logs = document.getElementById("logInput").value
    if not logs.strip():
        document.getElementById("aiOutput").innerText = "‚ùå No logs provided."
        return

    prompt = f"""You're an AI software engineer. These logs come from a self-test diagnostics run.

Read the logs and try to identify what code or workflow might need to be fixed.

Suggest an actionable fix or patch in clear, ready-to-use code.

Logs:
{logs}
"""
    openai.api_key = window.localStorage.getItem("openaiKey")
    try:
        response = openai.ChatCompletion.create(
            model="gpt-4-turbo",
            messages=[{"role": "user", "content": prompt}]
        )
        result = response['choices'][0]['message']['content']
        document.getElementById("aiOutput").innerText = result
    except Exception as e:
        document.getElementById("aiOutput").innerText = f"‚ö†Ô∏è Error: {e}"

document.getElementById("analyzeBtn").addEventListener("click", fix_logs)
  </py-script>

<div id="statusBadge" class="fixed top-4 right-4 z-50 px-3 py-1 rounded bg-green-600 text-white text-xs shadow">
  ‚úÖ Authenticated
</div>
<script>
  const statusBadge = document.getElementById("statusBadge");
  const openaiKey = localStorage.getItem("openaiKey");
  const githubToken = localStorage.getItem("githubToken");

  if (!openaiKey || !githubToken) {
    alert("üîê Missing API keys. Redirecting to setup...");
    window.location.href = "setup.html";
  }
</script>


<style>
  @keyframes pulseGlow {
    0%, 100% { box-shadow: 0 0 0 0 rgba(72, 187, 120, 0.7); }
    50% { box-shadow: 0 0 10px 4px rgba(72, 187, 120, 0.7); }
  }
</style>
<div id="statusBadge" class="fixed top-4 right-4 z-50 px-3 py-1 rounded bg-green-600 text-white text-xs shadow animate-pulse" style="animation: pulseGlow 2s infinite;">
  ‚úÖ Authenticated
</div>
<script>
  const statusBadge = document.getElementById("statusBadge");
  const openaiKey = localStorage.getItem("openaiKey");
  const githubToken = localStorage.getItem("githubToken");

  if (!openaiKey || !githubToken) {
    alert("üîê Missing API keys. Redirecting to setup...");
    window.location.href = "setup.html";
  }
</script>


<style>
  @keyframes pulseGlow {
    0%, 100% { box-shadow: 0 0 0 0 rgba(72, 187, 120, 0.7); }
    50% { box-shadow: 0 0 10px 4px rgba(72, 187, 120, 0.7); }
  }
  .badge-error {
    background-color: #DC2626 !important;
    animation: none !important;
    box-shadow: 0 0 0 2px rgba(220, 38, 38, 0.7);
  }
</style>

<div id="statusBadge" class="fixed top-4 right-4 z-50 px-3 py-1 rounded bg-green-600 text-white text-xs shadow" style="animation: pulseGlow 2s infinite;">
  ‚úÖ Authenticated
</div>

<script>
  const badge = document.getElementById("statusBadge");
  const openaiKey = localStorage.getItem("openaiKey");
  const githubToken = localStorage.getItem("githubToken");

  if (!openaiKey || !githubToken) {
    alert("üîê Missing API keys. Redirecting to setup...");
    window.location.href = "setup.html";
  }

  // Live test ping OpenAI and GitHub once to update badge status
  async function verifyLiveAuth() {
    let success = true;

    try {
      const aiRes = await fetch("https://api.openai.com/v1/models", {
        headers: { Authorization: `Bearer ${openaiKey}` }
      });
      if (!aiRes.ok) success = false;
    } catch (err) { success = false; }

    try {
      const ghRes = await fetch("https://api.github.com/user", {
        headers: { Authorization: `token ${githubToken}` }
      });
      if (!ghRes.ok) success = false;
    } catch (err) { success = false; }

    if (!success) {
      badge.innerText = "‚ùå Auth Error";
      badge.classList.add("badge-error");
    }
  }

  verifyLiveAuth();
</script>

</body>
</html>


<!-- GitHub OAuth Simulated UI -->
<div class="mt-6 p-4 bg-gray-700 rounded">
  <h2 class="text-lg font-bold mb-2">üîê GitHub Auto-Fix Integration</h2>
  <p class="text-sm mb-3">Authorize this tool to auto-commit fixes directly to your repo.</p>
  <a href="https://github.com/login/oauth/authorize?client_id=YOUR_CLIENT_ID&scope=repo" class="bg-green-600 px-4 py-2 rounded text-white hover:bg-green-700">üîë Connect GitHub</a>
  <p class="text-xs mt-2 text-gray-300">Replace YOUR_CLIENT_ID in source before using in production.</p>
</div>

<!-- Simulated Commit Handler -->
<script>
  async function pushFixToGitHub(repo, branch, filePath, newContent, token) {
    const apiBase = `https://api.github.com/repos/${repo}/contents/${filePath}`;

    const getFile = await fetch(apiBase, {
      headers: { Authorization: `token ${token}` }
    });
    const fileData = await getFile.json();

    const body = {
      message: "ü§ñ AI Auto-Fix Commit",
      content: btoa(newContent),
      sha: fileData.sha,
      branch: branch
    };

    const commit = await fetch(apiBase, {
      method: "PUT",
      headers: {
        Authorization: `token ${token}`,
        "Content-Type": "application/json"
      },
      body: JSON.stringify(body)
    });

    return commit.ok ? "‚úÖ Fix committed!" : `‚ùå Failed: ${commit.statusText}`;
  }
</script>
